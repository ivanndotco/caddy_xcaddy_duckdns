name: Check for Caddy and Plugin Updates

on:
  schedule:
    # Check for updates once per week (every Monday at 2 AM UTC)
    - cron: "0 2 * * 1"
  workflow_dispatch:

jobs:
  check-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest versions from GitHub
        id: latest
        run: |
          # Get latest Caddy release from GitHub
          CADDY_VERSION=$(curl -s https://api.github.com/repos/caddyserver/caddy/releases/latest | jq -r '.tag_name')
          echo "caddy=$CADDY_VERSION" >> $GITHUB_OUTPUT
          echo "Latest Caddy version: $CADDY_VERSION"

          # Get latest DuckDNS plugin version from GitHub tags
          DUCKDNS_VERSION=$(curl -s https://api.github.com/repos/caddy-dns/duckdns/tags | jq -r '.[0].name')
          echo "duckdns=$DUCKDNS_VERSION" >> $GITHUB_OUTPUT
          echo "Latest DuckDNS plugin version: $DUCKDNS_VERSION"

      - name: Get current versions from file
        id: current
        run: |
          if [ -f versions.json ]; then
            CURRENT_CADDY=$(jq -r '.caddy' versions.json)
            CURRENT_DUCKDNS=$(jq -r '.duckdns' versions.json)
          else
            CURRENT_CADDY="none"
            CURRENT_DUCKDNS="none"
          fi
          echo "caddy=$CURRENT_CADDY" >> $GITHUB_OUTPUT
          echo "duckdns=$CURRENT_DUCKDNS" >> $GITHUB_OUTPUT
          echo "Current Caddy version: $CURRENT_CADDY"
          echo "Current DuckDNS version: $CURRENT_DUCKDNS"

      - name: Compare versions
        id: compare
        run: |
          echo "Version Comparison:"
          echo "  Caddy:   ${{ steps.current.outputs.caddy }} → ${{ steps.latest.outputs.caddy }}"
          echo "  DuckDNS: ${{ steps.current.outputs.duckdns }} → ${{ steps.latest.outputs.duckdns }}"
          echo ""

          CHANGED=()
          if [ "${{ steps.latest.outputs.caddy }}" != "${{ steps.current.outputs.caddy }}" ]; then
            CHANGED+=("caddy")
            echo "✅ Caddy version changed: ${{ steps.current.outputs.caddy }} → ${{ steps.latest.outputs.caddy }}"
          fi

          if [ "${{ steps.latest.outputs.duckdns }}" != "${{ steps.current.outputs.duckdns }}" ]; then
            CHANGED+=("duckdns")
            echo "✅ DuckDNS plugin version changed: ${{ steps.current.outputs.duckdns }} → ${{ steps.latest.outputs.duckdns }}"
          fi

          if [ ${#CHANGED[@]} -gt 0 ]; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            # Convert array to JSON array format
            CHANGED_JSON=$(printf '%s\n' "${CHANGED[@]}" | jq -R . | jq -s .)
            echo "changed=$CHANGED_JSON" >> $GITHUB_OUTPUT
            echo ""
            echo "Will update versions.json and trigger build"
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
            echo "changed=[]" >> $GITHUB_OUTPUT
            echo "ℹ️  All versions are up to date"
          fi

      - name: Update versions file
        run: |
          # Always update versions.json with current timestamp to prevent workflow suspension
          # (GitHub suspends workflows after 60 days of inactivity)
          cat > versions.json << EOF
          {
            "caddy": "${{ steps.latest.outputs.caddy }}",
            "duckdns": "${{ steps.latest.outputs.duckdns }}",
            "last_checked": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "changed": ${{ steps.compare.outputs.changed }}
          }
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add versions.json

          # Use descriptive commit message when versions change, simple message otherwise
          if [ "${{ steps.compare.outputs.update_needed }}" == "true" ]; then
            git commit -m "Update versions: Caddy ${{ steps.latest.outputs.caddy }}, DuckDNS ${{ steps.latest.outputs.duckdns }}"
          else
            git commit -m "chore: update timestamp to prevent workflow suspension"
          fi

          git push

      - name: Trigger Docker build
        if: steps.compare.outputs.update_needed == 'true'
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: version-update
          client-payload: '{"caddy": "${{ steps.latest.outputs.caddy }}", "duckdns": "${{ steps.latest.outputs.duckdns }}", "changed": ${{ steps.compare.outputs.changed }}}'
